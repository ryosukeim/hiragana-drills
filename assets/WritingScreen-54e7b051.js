import{s as f,i as u,_ as p}from"./index-0daa4ca9.js";import{a as y}from"./PracticeScreen-79a33f73.js";import{g as b}from"./kana-data-373ad0d8.js";class v{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.isDrawing=!1,this.currentStroke=[],this.strokes=[],this.setupCanvas(),this.attachEvents()}setupCanvas(){const t=this.canvas.getBoundingClientRect();this.canvas.width=t.width*window.devicePixelRatio,this.canvas.height=t.height*window.devicePixelRatio,this.ctx.scale(window.devicePixelRatio,window.devicePixelRatio),this.ctx.lineWidth=4,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.strokeStyle="#ffffff"}attachEvents(){this.canvas.addEventListener("mousedown",t=>this.startStroke(t)),this.canvas.addEventListener("mousemove",t=>this.continueStroke(t)),this.canvas.addEventListener("mouseup",()=>this.endStroke()),this.canvas.addEventListener("mouseleave",()=>this.endStroke()),this.canvas.addEventListener("touchstart",t=>{t.preventDefault(),this.startStroke(t.touches[0])}),this.canvas.addEventListener("touchmove",t=>{t.preventDefault(),this.continueStroke(t.touches[0])}),this.canvas.addEventListener("touchend",t=>{t.preventDefault(),this.endStroke()})}getCoords(t){const e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top,timestamp:Date.now()}}startStroke(t){this.isDrawing=!0;const e=this.getCoords(t);this.currentStroke=[e],this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y)}continueStroke(t){if(!this.isDrawing)return;const e=this.getCoords(t);this.currentStroke.push(e),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}endStroke(){this.isDrawing&&(this.isDrawing=!1,this.currentStroke.length>2&&this.strokes.push([...this.currentStroke]),this.currentStroke=[])}clear(){const t=this.canvas.getBoundingClientRect();this.ctx.clearRect(0,0,t.width,t.height),this.strokes=[],this.currentStroke=[]}getStrokes(){return this.strokes}drawGuide(t){this.ctx.save(),this.ctx.font='200px "Kiwi Maru", sans-serif',this.ctx.fillStyle="rgba(255, 255, 255, 0.2)",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const e=this.canvas.getBoundingClientRect();this.ctx.fillText(t,e.width/2,e.height/2),this.ctx.restore()}normalizeStrokes(){if(this.strokes.length===0)return[];let t=1/0,e=1/0,n=-1/0,i=-1/0;this.strokes.forEach(r=>{r.forEach(o=>{t=Math.min(t,o.x),e=Math.min(e,o.y),n=Math.max(n,o.x),i=Math.max(i,o.y)})});const a=n-t,c=i-e,s=Math.max(a,c);return s===0?[]:this.strokes.map(r=>r.map(o=>({x:(o.x-t)/s,y:(o.y-e)/s})))}smoothStrokes(t,e=3){return t.map(n=>{if(n.length<e)return n;const i=[];for(let a=0;a<n.length;a++){const c=Math.max(0,a-Math.floor(e/2)),s=Math.min(n.length,a+Math.ceil(e/2)),r=n.slice(c,s),o=r.reduce((l,d)=>l+d.x,0)/r.length,h=r.reduce((l,d)=>l+d.y,0)/r.length;i.push({x:o,y:h})}return i})}resampleStroke(t,e=32){if(t.length===0)return[];if(t.length===1)return t;let n=0;for(let s=1;s<t.length;s++){const r=t[s].x-t[s-1].x,o=t[s].y-t[s-1].y;n+=Math.sqrt(r*r+o*o)}if(n===0)return[t[0]];const i=n/(e-1),a=[t[0]];let c=0;for(let s=1;s<t.length;s++){const r=t[s].x-t[s-1].x,o=t[s].y-t[s-1].y,h=Math.sqrt(r*r+o*o);for(c+=h;c>=i&&a.length<e;){const l=(c-i)/h,d={x:t[s].x-l*r,y:t[s].y-l*o};a.push(d),c-=i}}for(;a.length<e;)a.push(t[t.length-1]);return a.slice(0,e)}}class w{constructor(){this.templates=this.generateTemplates()}generateTemplates(){return{}}evaluate(t,e,n){if(!t||t.length===0)return{score:0,feedback:"No drawing detected",details:{}};const i=this.normalizeStrokeSet(t),a=this.scoreStrokeCount(t.length,n),c=this.scoreComplexity(i),s=this.scoreCoverage(i),r=Math.round(a*.2+c*.4+s*.4);return{score:Math.max(0,Math.min(100,r)),strokeCountScore:a,complexityScore:c,coverageScore:s,feedback:this.generateFeedback(r),details:{strokeCount:t.length,expectedStrokeCount:n}}}normalizeStrokeSet(t){if(t.length===0)return[];let e=1/0,n=1/0,i=-1/0,a=-1/0;t.forEach(o=>{o.forEach(h=>{e=Math.min(e,h.x),n=Math.min(n,h.y),i=Math.max(i,h.x),a=Math.max(a,h.y)})});const c=i-e,s=a-n,r=Math.max(c,s);return r===0?t:t.map(o=>o.map(h=>({x:(h.x-e)/r,y:(h.y-n)/r})))}scoreStrokeCount(t,e){if(e===0)return 80;const n=Math.abs(t-e);return n===0?100:n===1?85:n===2?70:60}scoreComplexity(t){let e=0,n=0;t.forEach(a=>{e+=a.length;for(let c=1;c<a.length;c++){const s=a[c].x-a[c-1].x,r=a[c].y-a[c-1].y;n+=Math.sqrt(s*s+r*r)}});const i=n/t.length;return i<.1?40:i<.3?70:i<.8?95:85}scoreCoverage(t){if(t.length===0)return 0;let e=1/0,n=1/0,i=-1/0,a=-1/0;t.forEach(s=>{s.forEach(r=>{e=Math.min(e,r.x),n=Math.min(n,r.y),i=Math.max(i,r.x),a=Math.max(a,r.y)})});const c=(i-e)*(a-n);return c<.1?40:c<.2?65:c<.4?85:c<.7?100:c<.9?95:75}generateFeedback(t){return t>=90?"feedback_perfect":t>=80?"feedback_excellent":t>=70?"feedback_great":t>=60?"feedback_good":t>=40?"feedback_tryAgain":"feedback_keepPracticing"}distance(t,e){const n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)}}const M=new w;class C{constructor(t,e,n,i,a){this.router=t,this.word=e,this.kanaReading=n,this.kanaSet=i,this.practiceScreen=a,this.mode="trace",this.captures=[],this.hintMode="normal"}async loadSettings(){this.hintMode=await f.getSetting("hintMode","normal")}render(){const t=document.createElement("div");t.className="screen p-md",t.style.maxWidth="1000px",t.style.margin="0 auto";const e=document.createElement("div");e.className="flex items-center justify-between mb-md",e.innerHTML=`
      <h2 data-i18n="writing_title">${u.t("writing_title")}</h2>
      <button class="btn btn-icon btn-secondary" id="back-btn">‚Üê</button>
    `;const n=document.createElement("div");n.className="card card-gradient p-sm mb-md text-center",n.innerHTML=`
      <div class="flex items-center justify-center gap-md">
        <div class="text-xl font-bold">${this.word.english}</div>
        <div class="text-lg text-secondary">(${this.word.romaji})</div>
        <button class="btn btn-icon btn-secondary" id="replay-audio">üîä</button>
      </div>
    `;const i=document.createElement("div");i.className="flex gap-sm mb-md justify-center",i.innerHTML=`
      <button class="btn btn-primary" id="trace-mode-btn" style="width: 120px;">
        <span data-i18n="writing_trace">${u.t("writing_trace")}</span>
      </button>
      <button class="btn btn-secondary" id="freewrite-mode-btn" style="width: 120px;">
        <span data-i18n="writing_freeWrite">${u.t("writing_freeWrite")}</span>
      </button>
    `;const a=document.createElement("div");a.className="flex flex-wrap justify-center gap-md mb-lg multi-char-container",a.id="canvases-container",this.kanaReading.split("").forEach((r,o)=>{const h=document.createElement("div");h.className="flex-col items-center";const l=document.createElement("div");l.className="text-lg font-bold mb-xs text-center",l.innerText=o+1;const d=document.createElement("div");d.className="card p-xs",d.style.background="var(--bg-card)";const m=document.createElement("canvas");m.id=`writing-canvas-${o}`,m.width=250,m.height=250,m.style.width="250px",m.style.height="250px",m.style.background="var(--color-space-deep)",m.style.borderRadius="var(--radius-sm)",m.style.cursor="crosshair",m.style.touchAction="none",m.style.border="2px solid var(--border-color)",d.appendChild(m);const g=document.createElement("div");g.id=`feedback-${o}`,g.style.height="20px",g.className="text-center mt-xs text-sm font-bold",h.appendChild(l),h.appendChild(d),h.appendChild(g),a.appendChild(h)});const s=document.createElement("div");return s.className="flex gap-md justify-center",s.innerHTML=`
      <button class="btn btn-secondary" id="clear-btn">
        üóëÔ∏è <span data-i18n="writing_clear">${u.t("writing_clear")}</span>
      </button>
      <button class="btn btn-primary btn-large" id="submit-btn" style="min-width: 200px;">
        ‚úì <span data-i18n="writing_submit">${u.t("writing_submit")}</span>
      </button>
    `,t.appendChild(e),t.appendChild(n),t.appendChild(i),t.appendChild(a),t.appendChild(s),t}async onEnter(){await this.loadSettings(),this.captures=[],this.kanaReading.split("").forEach((e,n)=>{const i=document.getElementById(`writing-canvas-${n}`);i.width=i.offsetWidth,i.height=i.offsetHeight;const a=new v(i);this.captures.push({instance:a,char:e,index:n})}),this.setMode("trace"),document.getElementById("back-btn").onclick=()=>this.router.goBack(),document.getElementById("replay-audio").onclick=()=>{y.playJapanese(this.kanaReading)},document.getElementById("trace-mode-btn").onclick=()=>this.setMode("trace"),document.getElementById("freewrite-mode-btn").onclick=()=>this.setMode("freeWrite"),document.getElementById("clear-btn").onclick=()=>this.clearAll(),document.getElementById("submit-btn").onclick=()=>this.submitAll()}setMode(t){this.mode=t;const e=document.getElementById("trace-mode-btn"),n=document.getElementById("freewrite-mode-btn");t==="trace"?(e.className="btn btn-primary",n.className="btn btn-secondary"):(e.className="btn btn-secondary",n.className="btn btn-primary"),this.clearAll()}clearAll(){this.captures.forEach(t=>{t.instance.clear();const e=document.getElementById(`feedback-${t.index}`);e&&(e.innerText=""),this.mode==="trace"&&t.instance.drawGuide(t.char)})}async submitAll(){let t=0,e=!0,n=0;for(const a of this.captures){const c=a.instance.getStrokes(),s=document.getElementById(`feedback-${a.index}`);if(c.length===0){s.innerHTML='<span style="color:red">Empty!</span>',s.className="text-center mt-xs text-sm font-bold animate-shake",e=!1;continue}n++;const r=a.instance.normalizeStrokes(),o=a.instance.smoothStrokes(r),h=b(a.char,this.kanaSet==="katakana"),l=h?h.strokes:0,d=M.evaluate(o,a.char,l);t+=d.score,d.score>=50?(s.innerHTML=`<span style="color:var(--color-success)">Good! (${Math.round(d.score)})</span>`,await f.saveWordProgress(this.word.id,a.char,d.score,this.mode)):(s.innerHTML=`<span style="color:orange">Try again (${Math.round(d.score)})</span>`,e=!1)}if(n<this.captures.length)return;const i=Math.round(t/this.captures.length);(e||i>=50)&&await this.finishWord(i)}async finishWord(t){const e=Math.round(t*this.captures.length/2);await f.updateStreak();const n=await f.addXP(e),i={score:t,feedback:"Great job practicing the whole word!",match:t>=60},{ResultsScreen:a}=await p(()=>import("./ResultsScreen-903db67c.js"),["assets/ResultsScreen-903db67c.js","assets/index-0daa4ca9.js","assets/index-9c405b81.css"]);this.router.navigateTo(new a(this.router,i,e,n.leveledUp,n.level,this.practiceScreen))}}export{C as WritingScreen};
